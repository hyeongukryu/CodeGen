"use strict";var e=require("fs"),r=require("fs/promises"),s=require("path");const t=process.argv[2].replace(/\/$/,"");async function i(e,r){try{const s=new URLSearchParams;s.append("swr",e?"true":"false"),s.append("split","true"),s.append("configFilePath",r);const i=await fetch(`${t}/code-gen-api?${s.toString()}`);return await i.json()}catch{}return null}function n(e){if(null===e&&(console.error("Failed to get code"),process.exit(1)),e.startsWith("ERROR\nERROR_BEGIN\n")){const r=e.indexOf("\nERROR_END\n"),s=e.substring(18,r);console.error(s),process.exit(1)}}async function c(e,t){await r.mkdir(t,{recursive:!0});const i=e.split("\n");let n=null,c="";async function a(e){await o(),n=e}async function o(){null!==n&&(await r.writeFile(s.join(t,n),c),n=null,c="")}for(const e of i)if(e.startsWith("// __CODEGEN_VERSION_2_FILE_BOUNDARY__ ")){const r=e.split(" ")[2];await a(r)}else null===n&&(console.error("Unexpected line outside of file boundary"),process.exit(1)),c+=e+"\n";await o()}t||(console.error("Usage: node update-api.js <server-root>"),process.exit(1)),async function(){e.existsSync("src/api/client")&&e.existsSync("src/api/server")||(console.error("src/api/client and src/api/server must exist"),process.exit(1));const s=await i(!0,"../client.config");n(s),console.log(s);const t=await i(!1,"../server.config");n(t),console.log(t),await r.rm("src/api/client",{recursive:!0}),await r.rm("src/api/server",{recursive:!0}),await c(s,"src/api/client"),await c(t,"src/api/server")}();
